---
title: "Dashboard: Recently Archived CRAN Packages"

execute:
  freeze: false
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  echo = FALSE
)

max_days <- 5*7
```

CRAN packages are often archived and equally often after being taken
off CRAN they can be brought up to CRAN.

This dashboard updates with the latest `{r} max_days` days of CRAN
archived or unarchived packages from [PACKAGES.in] the CRAN Team uses
to document this process.

To avoid being archived, make sure to fix any package issues in time.
If you don't think you can reach the deadline you got, you might be
able to convince the CRAN maintainers to extend the deadline. It is
also useful to review [CRAN Repository Policy] once in a while to stay
up to date with the CRAN requirements.

If your package has already been archived, you can get back to CRAN by
fixing the issues pointed on the initial email, as well as any other
new issue that might show up.  Check the package before sending it and
explain to the volunteers how you fixed it.  If you have problems you
don't know how to solve, you can search for a solution in the
[r-package-devel mailing list] and ask there for help with the package
development.

```{r dashboard}
library("dplyr")

#' @importFrom jsonlite read_json
cranhaven_packages <- local({
  data <- NULL
  
  function(url = "https://raw.githubusercontent.com/cranhaven/cranhaven.r-universe.dev/main/packages.json") {
    if (!is.null(data)) return(data)
    db <- jsonlite::read_json(url)
    ## Patch missing fields
    names <- unique(unlist(lapply(db, FUN = names)))
    db <- lapply(db, FUN = function(x, names) {
      missing <- setdiff(names, names(x))
      for (name in missing) {
        x[[name]] <- NA_character_
      }
      as.data.frame(x)
    }, names = names)
    stopifnot(lengths(db) == length(db[[1]]))
    db <- do.call(rbind, db)
    db$archived_on <- as.Date(db$archived_on)
    db$x_cran_comment_date <- as.Date(db$x_cran_comment_date)
    data <<- db
    data
  }
}) ## cranhaven_packages()

#' @importFrom ciw incoming
cran_incoming <- local({
  data <- NULL
  
  function() {
    if (!is.null(data)) return(data)
    db <- ciw::incoming(folder = c("pretest", "recheck", "inspect", "pending", "waiting", "newbies"), check = FALSE)
    db <- as.data.frame(db)
    colnames(db) <- tolower(colnames(db))
    db$package <- gsub("_.*", "", db$name)
    db$version <- gsub("(.*_|[.]tar[.]gz)", "", db$name)
    db <- db[, c("package", "version", "folder", "time")]
    data <<- db
    data
  }
})

history <- cranhaven_packages()
incoming <- cran_incoming()
incoming <- incoming[, c("package", "folder")]
colnames(incoming)[2] <- "cran_incoming"
history <- merge(history, incoming, by = "package", all.x = TRUE)

history$links <- with(history, paste(
  sprintf("checks=https://cran-archive.r-project.org/web/checks/%s/%s_check_results_%s.html", sub("-.*", "", archived_on), archived_on, package),
  sprintf("source=https://github.com/cran/%s", package),
  sep = ", "
))


## Rename columns
history <- rename(history,
  "date"   = archived_on,
  "event"  = x_cran_comment_event,
  "reason" = x_cran_comment_reason
)

idxs <- which(!is.na(history$cran_incoming))
history$event[idxs] <- paste(history$event[idxs], "resubmitted", sep = ", ")

history <- history[, c("date", "package", "event", "reason", "links")]

# Show only recent packages
library("reactable")
history |> 
  reactable(
    columns = list(
      package = colDef(cell = function(value) {
        # Render as a link
        url <- sprintf("https://cran.r-project.org/package=%s", value)
        htmltools::tags$a(href = url, target = "_blank", as.character(value))
      }),

      event = colDef(cell = function(value) {
        values <- strsplit(value, split = ",", fixed = TRUE)[[1]]
        values <- gsub("(^[ ]+|[ ]+$)", "", values)
        if (!"resubmitted" %in% values) return(value)
        tags <- list()
        for (kk in seq_along(values)) {
          if (kk > 1) tags <- c(tags, list(htmltools::tags$text(", ")))
          value <- values[kk]
          if (value == "resubmitted") {
            tag <- htmltools::tags$a(href = "https://r-hub.github.io/cransays/articles/dashboard.html", target = "_blank", "resubmitted")
          } else {
            tag <- htmltools::tags$text(value)
          }
          tags <- c(tags, list(tag))
        }
        tags
      }),

      links = colDef(cell = function(value) {
        links <- strsplit(value, split = ",", fixed = TRUE)[[1]]
        links <- gsub("(^[[:blank:]]+|[[:blank:]]+$)", "", links)
        tags <- list()
        for (kk in seq_along(links)) {
          if (kk > 1) tags <- c(tags, list(htmltools::tags$text(", ")))

          link <- links[[kk]]
          label <- sub("=.*", "", link)
          url <- sub("[^=]*=", "", link)
          tags <- c(tags, list(htmltools::tags$a(href = url, target = "_blank", label)))
        }
        tags
      }),

      reason = colDef(cell = function(value) {
        tags <- list()
        
        if (grepl("requires archived package", value)) {
          pattern <- "(.*)'([^']+)'(.*)"
          while (grepl(pattern, value)) {
            prefix <- gsub(pattern, "\\1", value)
            prefix <- htmltools::tags$text(prefix)
            pkg <- gsub(pattern, "\\2", value)
            url <- sprintf("https://cran.r-project.org/package=%s", pkg)
            link <- htmltools::tags$a(href = url, target = "_blank", pkg)
            tags <- c(tags, list(prefix, link))
            value <- gsub(pattern, "\\3", value)
          }
        }

        pattern <- "foo(check problems|issues)( were not corrected.*)"
        if (grepl(pattern, value)) {
          ## FIXME: How to find date and pkg from within this reactive function?
          #url <- sprintf("https://cran-archive.r-project.org/web/checks/%s/%s_check_results_%s.html", sub("-.*", "", date), date, pkg)
          #link <- htmltools::tags$a(href = url, target = "_blank", pkg)
        }

        if (nchar(value) > 0) {
          tags <- c(tags, list(htmltools::tags$text(value)))
        }
        tags
      })
    ),
    defaultSorted = list("date" = "desc", "package" = "asc"),
    filterable = TRUE,
    defaultPageSize = 50)
```

[CRAN Repository Policy]: https://cran.r-project.org/web/packages/policies.html
[PACKAGES.in]: https://cran.r-project.org/src/contrib/PACKAGES.in
[r-package-devel mailing list]: https://stat.ethz.ch/mailman/listinfo/r-package-devel